<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Central | RJ Sports Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --amz-dark: #232f3e;       
            --amz-light-bg: #f2f4f8;   
            --amz-border: #d5d9d9;     
            --amz-text: #0f1111;       
            --amz-link: #007185;       
            --amz-orange: #f90;        
            --amz-btn: #FFD814;        
            --amz-btn-hover: #F7CA00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Open Sans', sans-serif; }
        body { background-color: var(--amz-light-bg); color: var(--amz-text); display: flex; flex-direction: column; min-height: 100vh; }

        /* HEADER */
        .top-navbar { background-color: var(--amz-dark); color: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .nav-logo { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .nav-logo span { color: var(--amz-orange); font-size: 14px; margin-top: 5px; }

        /* LAYOUT & SIDEBAR */
        .main-container { display: flex; flex: 1; }
        .sidebar { width: 250px; background-color: #fff; border-right: 1px solid var(--amz-border); padding-top: 20px; display: flex; flex-direction: column; min-height: calc(100vh - 50px); }
        .nav-item { padding: 12px 20px; color: var(--amz-text); text-decoration: none; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover { background-color: #f7fafa; color: var(--amz-link); }
        .nav-item.active { border-left-color: var(--amz-link); background-color: #f7fafa; color: var(--amz-link); }

        /* CONTENT */
        .content { flex: 1; padding: 30px; }
        .admin-section { display: none; animation: fadeIn 0.3s; }
        .admin-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; }

        /* KPIs */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: #fff; border: 1px solid var(--amz-border); border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .kpi-title { font-size: 14px; color: #565959; font-weight: 600; margin-bottom: 10px; }
        .kpi-value { font-size: 28px; font-weight: 700; color: var(--amz-text); }

        /* TABLE */
        .table-card { background: #fff; border: 1px solid var(--amz-border); border-radius: 8px; overflow: hidden; }
        .table-header { padding: 15px 20px; background: #fbfbfb; border-bottom: 1px solid var(--amz-border); font-weight: 700; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 20px; font-size: 13px; color: #565959; border-bottom: 1px solid var(--amz-border); }
        td { padding: 15px 20px; font-size: 14px; border-bottom: 1px solid #f0f2f2; }
        
        .status { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700; display: inline-block; }
        .status.Processing { background-color: #fff1e3; color: #b16a00; border: 1px solid #ffd199; }
        .status.Shipped { background-color: #e3f2fd; color: #005fcc; border: 1px solid #bfe0ff; }
        .status.Delivered { background-color: #e6f4ea; color: #007600; border: 1px solid #a3d9b1; }
        .status.Cancelled { background-color: #fce8e8; color: #cc0000; border: 1px solid #ffb3b3; }

        .btn-action { background: var(--amz-btn); border: 1px solid #FCD200; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; transition: 0.2s; }
        .btn-action:hover:not(:disabled) { background: var(--amz-btn-hover); }

        /* MODAL FOR STATUS UPDATE */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff; padding: 25px; border-radius: 8px; width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .close-modal { cursor: pointer; font-size: 20px; color: #878787; }
        .close-modal:hover { color: red; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--amz-border); border-radius: 4px; font-size: 14px; outline: none; margin-bottom: 15px; }

        /* UPLOAD FORM */
        .upload-form { background: #fff; padding: 25px; border-radius: 8px; border: 1px solid var(--amz-border); max-width: 600px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
    </style>
</head>
<body>

    <header class="top-navbar">
        <div class="nav-logo"><i class="fas fa-bars" style="margin-right:10px;"></i> RJ SPORTS <span>Admin Central</span></div>
        <div style="font-size: 14px; font-weight: 600;">Welcome, Admin</div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-tachometer-alt"></i> Dashboard</div>
            <div class="nav-item" onclick="switchTab('upload', this)"><i class="fas fa-upload"></i> Add Product</div>
            <a href="index.html" class="nav-item" target="_blank"><i class="fas fa-store"></i> View Store</a>
        </aside>

        <main class="content">
            <div id="sec-dashboard" class="admin-section active">
                <h1 class="page-title">Store Dashboard</h1>
                
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">Total Revenue</div>
                        <div class="kpi-value" id="kpi-revenue">‚Çπ0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Total Orders</div>
                        <div class="kpi-value" id="kpi-orders">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Live Products</div>
                        <div class="kpi-value" id="kpi-products">0</div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">Recent Orders</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID & Date</th>
                                <th>Customer Details</th>
                                <th>Total Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <tr><td colspan="5" style="text-align:center;">Loading orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="sec-upload" class="admin-section">
                <h1 class="page-title">Add New Product</h1>
                <div class="upload-form">
                    <form id="uploadForm">
                        <div class="form-group">
                            <label>Product ID (Unique)</label>
                            <input type="text" id="p-id" class="form-control" placeholder="e.g. RJ001" required>
                        </div>
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" id="p-name" class="form-control" placeholder="e.g. RJ Pro Cricket Bat" required>
                        </div>
                        <div class="form-group">
                            <label>Price (‚Çπ)</label>
                            <input type="number" id="p-price" class="form-control" placeholder="e.g. 2500" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="p-category" class="form-control">
                                <option value="Shoes">Shoes</option>
                                <option value="Cricket">Cricket Equipment</option>
                                <option value="Accessories">Accessories</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Upload Images (Max 3)</label>
                            <input type="file" id="p-images" class="form-control" name="productImages" multiple accept="image/*" required>
                        </div>
                        <button type="submit" id="uploadBtn" class="btn-action" style="padding:12px;">Upload to Store</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="statusModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                Update Order Status
                <i class="fas fa-times close-modal" onclick="closeModal()"></i>
            </div>
            <p style="font-size:13px; color:#565959; margin-bottom:10px;">Order ID: <strong id="modalOrderId" style="color:var(--amz-link);"></strong></p>
            
            <select id="newStatus" class="form-control">
                <option value="Processing">Processing (‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó)</option>
                <option value="Shipped">Shipped (‡§™‡§æ‡§†‡§µ‡§≤‡•Ä)</option>
                <option value="Delivered">Delivered (‡§™‡•ã‡§π‡•ã‡§ö‡§≤‡•Ä)</option>
                <option value="Cancelled">Cancelled (‡§∞‡§¶‡•ç‡§¶)</option>
            </select>
            
            <button class="btn-action" style="padding:10px;" id="saveStatusBtn" onclick="saveStatus()">Save Changes</button>
        </div>
    </div>

    <script>
        // 1. Tab Switching
        function switchTab(tabId, element) {
            document.querySelectorAll('.admin-section').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.getElementById(`sec-${tabId}`).classList.add('active');
            element.classList.add('active');
        }

        // 2. Fetch Orders & Dashboard Data
        async function fetchDashboardData() {
            try {
                const orderRes = await fetch('/api/orders');
                const orderData = await orderRes.json();
                const prodRes = await fetch('/api/products');
                const prodData = await prodRes.json();

                if(orderData.success) {
                    let totalRevenue = 0;
                    let html = '';
                    
                    document.getElementById('kpi-orders').innerText = orderData.orders.length;

                    orderData.orders.forEach(order => {
                        // ‡§´‡§ï‡•ç‡§§ Cancelled ‡§®‡§∏‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏‡§ö‡•á ‡§™‡•à‡§∏‡•á ‡§Æ‡•ã‡§ú‡§æ
                        if(order.status !== 'Cancelled') totalRevenue += order.total || 0;
                        
                        const date = new Date(order.date).toLocaleDateString('en-IN');
                        
                        html += `
                            <tr>
                                <td>
                                    <strong style="color:var(--amz-link);">#${order.orderId}</strong><br>
                                    <small>${date}</small>
                                </td>
                                <td>
                                    <strong>${order.customer}</strong><br>
                                    <small>${order.phone}</small>
                                </td>
                                <td><strong>‚Çπ${(order.total || 0).toLocaleString()}</strong></td>
                                <td><span class="status ${order.status}">${order.status}</span></td>
                                <td>
                                    <button class="btn-action" style="width:auto; padding:5px 15px;" onclick="openModal('${order.orderId}', '${order.status}')">Update</button>
                                </td>
                            </tr>
                        `;
                    });
                    document.getElementById('table-body').innerHTML = html || '<tr><td colspan="5" style="text-align:center;">No orders yet.</td></tr>';
                    document.getElementById('kpi-revenue').innerText = `‚Çπ${totalRevenue.toLocaleString()}`;
                }

                if(prodData.success) {
                    document.getElementById('kpi-products').innerText = prodData.products.length;
                }
            } catch (err) {
                console.error("Dashboard Error:", err);
            }
        }

        // 3. üü¢ MODAL LOGIC (STATUS UPDATE) üü¢
        let currentUpdatingOrderId = null;

        function openModal(orderId, currentStatus) {
            currentUpdatingOrderId = orderId;
            document.getElementById('modalOrderId').innerText = '#' + orderId;
            document.getElementById('newStatus').value = currentStatus;
            document.getElementById('statusModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('statusModal').classList.remove('active');
        }

        async function saveStatus() {
            const newStatus = document.getElementById('newStatus').value;
            const btn = document.getElementById('saveStatusBtn');
            btn.innerText = "Saving... ‚è≥";
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/orders/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: currentUpdatingOrderId, status: newStatus })
                });
                
                const data = await res.json();
                if(data.success) {
                    closeModal();
                    fetchDashboardData(); // ‡§ü‡•á‡§¨‡§≤ ‡§≤‡§ó‡•á‡§ö ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ
                } else {
                    alert("‚ùå Error: " + data.message);
                }
            } catch (error) {
                alert("‚ùå Connection Error.");
            } finally {
                btn.innerText = "Save Changes";
                btn.disabled = false;
            }
        }

        // 4. Product Upload 
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('uploadBtn');
            btn.innerText = "Uploading... ‚è≥";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('productId', document.getElementById('p-id').value);
            formData.append('name', document.getElementById('p-name').value);
            formData.append('price', document.getElementById('p-price').value);
            formData.append('category', document.getElementById('p-category').value);
            
            const fileInput = document.getElementById('p-images');
            for(let i=0; i<fileInput.files.length; i++) {
                formData.append('productImages', fileInput.files[i]);
            }

            try {
                const response = await fetch('/api/products/add', { method: 'POST', body: formData });
                const data = await response.json();
                
                if(data.success) {
                    alert("‚úÖ Product Uploaded!");
                    e.target.reset();
                    fetchDashboardData(); 
                } else { alert("‚ùå Error: " + data.message); }
            } catch (error) { alert("‚ùå Server Error."); } 
            finally { btn.innerText = "Upload to Store"; btn.disabled = false; }
        });

        // Start
        document.addEventListener('DOMContentLoaded', fetchDashboardData);
    </script>
</body>
</html>