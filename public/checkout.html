<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout | RJ Sports</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ... ‡§§‡•Å‡§Æ‡§ö‡•á ‡§Ü‡§ß‡•Ä‡§ö‡•á ‡§∏‡§∞‡•ç‡§µ CSS ‡§§‡§∏‡•á‡§ö ‡§†‡•á‡§µ‡§æ ... */
        :root {
            --bg-color: #f5f5f5;
            --text-color: #121212;
            --accent: #E10600; 
            --green: #03a685;
            --border-color: #e5e7eb;
        }
        /* (‡§Ø‡•á‡§•‡•á ‡§§‡•Å‡§Æ‡§ö‡•á ‡§∏‡§∞‡•ç‡§µ ‡§ú‡•Å‡§®‡•á CSS ‡§ï‡•ã‡§°‡•ç‡§∏ ‡•≤‡§° ‡§ï‡§∞‡§æ ‡§ú‡•á ‡§Æ‡•Ä ‡§Ü‡§ß‡•Ä ‡§¶‡§ø‡§≤‡•á ‡§π‡•ã‡§§‡•á) */
    </style>
</head>
<body>

<script>
    let cartItems = [];
    let subtotal = 0, totalDiscount = 0, deliveryFee = 0, finalTotal = 0;
    let selectedPayMethod = "UPI"; // Default

    document.addEventListener('DOMContentLoaded', () => {
        cartItems = JSON.parse(localStorage.getItem('rj_cart')) || [];
        if (cartItems.length === 0) {
            window.location.href = 'index.html';
            return;
        }
        renderSummary();
    });

    // ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§®‡§ø‡§µ‡§°‡§£‡•ç‡§Ø‡§æ‡§ö‡•á ‡§≤‡•â‡§ú‡§ø‡§ï (Fixed)
    function selectPayment(method, el) {
        // ‡§∏‡§∞‡•ç‡§µ ‡§¨‡•â‡§ï‡•ç‡§∏‡•á‡§∏‡§Æ‡§ß‡•Ç‡§® 'selected' ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ï‡§æ‡§¢‡§æ
        document.querySelectorAll('.option-box').forEach(box => {
            box.classList.remove('selected');
            const radio = box.querySelector('input[type="radio"]');
            if(radio) radio.checked = false;
        });

        // ‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§¨‡•â‡§ï‡•ç‡§∏‡§≤‡§æ ‡§π‡§æ‡§Ø‡§≤‡§æ‡§à‡§ü ‡§ï‡§∞‡§æ
        el.classList.add('selected');
        const currentRadio = el.querySelector('input[type="radio"]');
        if(currentRadio) {
            currentRadio.checked = true;
            selectedPayMethod = currentRadio.value; // UPI, Card, ‡§ï‡§ø‡§Ç‡§µ‡§æ COD
        }
    }

    // --- Premium Invoice Generation ---
    function generateInvoice(orderData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // ‡•ß. ‡§°‡§ø‡§ù‡§æ‡§à‡§® ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ (Black Top Bar)
        doc.setFillColor(18, 18, 18);
        doc.rect(0, 0, 210, 40, 'F');

        // ‡•®. ‡§¨‡•ç‡§∞‡§Å‡§° ‡§≤‡•ã‡§ó‡•ã ‡§Ü‡§£‡§ø ‡§®‡§æ‡§µ
        doc.setFont("Assistant", "bold");
        doc.setFontSize(28);
        doc.setTextColor(255, 255, 255);
        doc.text("RJ", 20, 25);
        doc.setTextColor(225, 6, 0); // Red
        doc.text("SPORTS", 35, 25);

        doc.setFontSize(10);
        doc.setTextColor(200, 200, 200);
        doc.text("PREMIUM GEAR & FOOTWEAR", 20, 32);

        // ‡•©. ‡§á‡§®‡•ç‡§µ‡•â‡§á‡§∏ ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        doc.text(`INVOICE: #${orderData.orderId}`, 140, 20);
        doc.text(`DATE: ${new Date().toLocaleDateString()}`, 140, 27);

        // ‡•™. ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä (Section)
        doc.setTextColor(18, 18, 18);
        doc.setFontSize(12);
        doc.text("CUSTOMER DETAILS", 20, 55);
        doc.setDrawColor(225, 6, 0);
        doc.line(20, 57, 50, 57); // Underline

        doc.setFontSize(10);
        doc.setTextColor(80);
        doc.text(`Name: ${orderData.customer}`, 20, 65);
        doc.text(`Phone: ${orderData.phone}`, 20, 70);
        doc.text(`Address: ${orderData.address}`, 20, 75);

        // ‡•´. ‡§Ü‡§Ø‡§ü‡§Æ ‡§ü‡•á‡§¨‡§≤ (Modern Table)
        const tableRows = orderData.items.map(item => [
            item.name.toUpperCase(),
            `UK ${item.size}`,
            item.quantity,
            `INR ${item.price.toLocaleString()}`
        ]);

        doc.autoTable({
            startY: 85,
            head: [['PRODUCT DESCRIPTION', 'SIZE', 'QTY', 'UNIT PRICE']],
            body: tableRows,
            theme: 'striped',
            headStyles: { fillColor: [18, 18, 18], textColor: [255, 255, 255], fontStyle: 'bold' },
            bodyStyles: { textColor: [50, 50, 50] },
            alternateRowStyles: { fillColor: [245, 245, 245] }
        });

        // ‡•¨. ‡§´‡§æ‡§Ø‡§®‡§≤ ‡§ï‡•Ö‡§≤‡•ç‡§ï‡•ç‡§Ø‡•Å‡§≤‡•á‡§∂‡§® (Price Details)
        const finalY = doc.lastAutoTable.finalY + 15;
        doc.setDrawColor(230);
        doc.line(120, finalY, 190, finalY);

        doc.setFontSize(10);
        doc.text("Payment Method:", 20, finalY + 5);
        doc.setTextColor(0);
        doc.text(orderData.paymentMethod, 60, finalY + 5);

        doc.setFontSize(14);
        doc.setFont("Assistant", "bold");
        doc.text("TOTAL AMOUNT:", 120, finalY + 15);
        doc.setTextColor(225, 6, 0);
        doc.text(`INR ${orderData.total.toLocaleString()}`, 165, finalY + 15);

        // ‡•≠. ‡§´‡•Å‡§ü‡§∞ (Footer Badges)
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text("This is a computer-generated invoice. No signature required.", 20, 280);
        doc.text("Thank you for choosing RJ Sports India.", 20, 285);

        // ‡•Æ. ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ
        doc.save(`RJ_Invoice_${orderData.orderId}.pdf`);
    }

    async function placeOrder() {
        // (‡§§‡•Å‡§Æ‡§ö‡•á ‡§∏‡§∞‡•ç‡§µ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§µ‡•ç‡§π‡•Ö‡§≤‡§ø‡§°‡•á‡§∂‡§® ‡§ï‡•ã‡§°‡•ç‡§∏ ‡§á‡§•‡•á ‡§∞‡§æ‡§π‡•Ç ‡§¶‡•ç‡§Ø‡§æ)
        const name = document.getElementById('c-name').value;
        const phone = document.getElementById('c-phone').value;
        const address = document.getElementById('s-address').value;
        const city = document.getElementById('s-city').value;
        const pin = document.getElementById('s-pin').value;

        if(!name || phone.length !== 10) return alert("Please fill details!");

        const orderId = 'RJ' + Math.floor(Math.random() * 1000000);
        const orderData = { 
            orderId, 
            customer: name, 
            phone, 
            address: `${address}, ${city} - ${pin}`, 
            items: cartItems, 
            total: finalTotal, 
            paymentMethod: selectedPayMethod 
        };

        // WhatsApp Message Construction
        const msg = `üèè *RJ SPORTS - NEW ORDER!* üèè\n` +
                    `-----------------------------------\n` +
                    `*üÜî Order ID:* #${orderId}\n` +
                    `*üë§ Customer:* ${name}\n` +
                    `*üí≥ Payment:* ${selectedPayMethod}\n` +
                    `*üí∞ Total:* ‚Çπ${finalTotal.toLocaleString()}\n` +
                    `-----------------------------------\n` +
                    `_Invoice downloaded. Please confirm delivery!_`;

        try {
            // ‡•ß. ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ
            await fetch('/api/place-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            // ‡•®. ‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§¨‡§ø‡§≤ ‡§°‡§æ‡§ä‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ
            generateInvoice(orderData);

            // ‡•©. ‡§∏‡§ï‡•ç‡§∏‡•á‡§∏ ‡§Æ‡•á‡§∏‡•á‡§ú ‡§Ü‡§£‡§ø ‡§∞‡§ø‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü
            document.getElementById('success-modal').style.display = 'flex';
            setTimeout(() => {
                const waUrl = `https://wa.me/919359239161?text=${encodeURIComponent(msg)}`;
                window.location.href = waUrl;
                localStorage.removeItem('rj_cart');
            }, 3000);

        } catch (e) {
            generateInvoice(orderData);
            window.location.href = `https://wa.me/919359239161?text=${encodeURIComponent(msg)}`;
        }
    }
</script>

</body>
</html>