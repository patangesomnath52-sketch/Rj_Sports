<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout | RJ Sports</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        if (localStorage.getItem('rj_theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #121212;
            --header-bg: #fff;
            --card-bg: #fff;
            --border-color: #e5e7eb;
            --accent: #E10600; 
            --green: #03a685;
        }

        html.dark-mode {
            --bg-color: #121212;
            --text-color: #e5e7eb;
            --header-bg: #1f2937;
            --card-bg: #1e293b;
            --border-color: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Assistant', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); transition: 0.3s; padding-bottom: 80px; }

        .header { background: var(--header-bg); padding: 15px 5%; box-shadow: 0 1px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 24px; font-weight: 900; text-decoration: none; color: var(--text-color); text-transform: uppercase; }
        .logo span { color: var(--accent); }
        .secure-tag { color: var(--green); font-weight: 800; font-size: 13px; display: flex; align-items: center; gap: 5px; }

        .checkout-wrapper { max-width: 1100px; margin: 30px auto; display: flex; gap: 30px; padding: 0 20px; align-items: flex-start; }
        .left-column { flex: 1.5; display: flex; flex-direction: column; gap: 20px; }
        .right-column { flex: 1; position: sticky; top: 80px; }

        .checkout-section { background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 25px; border: 1px solid var(--border-color); }
        .section-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--text-color); text-transform: uppercase; }
        .section-title i { color: var(--accent); }

        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 13px; font-weight: 700; color: #535665; }
        .form-input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 15px; outline: none; background: var(--bg-color); color: var(--text-color); font-weight: 600; transition: 0.2s; }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; margin-top: 5px; cursor: pointer; }
        .checkbox-group input { width: 18px; height: 18px; accent-color: var(--green); }

        .option-box { border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; background: var(--bg-color); }
        .option-box.selected { border-color: var(--accent); background: #fff5f5; }
        .opt-left { display: flex; align-items: center; gap: 15px; }
        .opt-radio { accent-color: var(--accent); width: 18px; height: 18px; }
        .opt-title { font-weight: 800; font-size: 15px; }
        .opt-desc { font-size: 12px; color: #878787; font-weight: 600; margin-top: 3px; }
        .opt-price { font-weight: 800; font-size: 15px; }

        .summary-card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid var(--border-color); overflow: hidden; }
        .summary-items { max-height: 300px; overflow-y: auto; padding: 20px; border-bottom: 1px solid var(--border-color); }
        .s-item { display: flex; gap: 15px; margin-bottom: 15px; }
        .s-img { width: 60px; height: 60px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border-color); }
        .s-info { flex: 1; }
        .s-name { font-size: 14px; font-weight: 800; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamps: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .s-meta { font-size: 12px; color: #878787; font-weight: 600; }
        .s-price { font-size: 14px; font-weight: 800; margin-top: 5px; }

        .summary-totals { padding: 20px; background: #fafafa; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; font-weight: 600; color: #535665; }
        .calc-total { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; font-size: 20px; font-weight: 900; color: var(--text-color); }
        
        .savings-tag { background: #e8f5e9; color: var(--green); padding: 10px; border-radius: 6px; text-align: center; font-size: 13px; font-weight: 800; margin: 15px 20px; border: 1px dashed var(--green); }

        .trust-section { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: var(--card-bg); border-top: 1px solid var(--border-color); }
        .trust-item { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 700; color: #535665; }
        .trust-item i { color: var(--green); font-size: 16px; }

        .btn-place-order { background: var(--accent); color: white; border: none; padding: 18px; font-size: 16px; font-weight: 800; border-radius: 6px; cursor: pointer; text-transform: uppercase; width: 100%; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }

        #toast { visibility: hidden; min-width: 250px; background: #333; color: #fff; text-align: center; border-radius: 4px; padding: 15px; position: fixed; z-index: 3000; left: 50%; top: 20px; transform: translateX(-50%); font-weight: bold; }
        #toast.show { visibility: visible; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 40px; border-radius: 12px; text-align: center; max-width: 400px; width: 90%; animation: slideUp 0.4s ease; }
        .modal-icon { font-size: 60px; color: #388e3c; margin-bottom: 20px; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @media (max-width: 768px) {
            .checkout-wrapper { flex-direction: column-reverse; padding: 0; margin: 0; gap: 0; }
            .left-column, .right-column { width: 100%; }
            .mobile-sticky-bar { display: block; position: fixed; bottom: 0; width: 100%; padding: 15px; background: var(--card-bg); border-top: 1px solid var(--border-color); z-index: 1001; }
            .desktop-btn { display: none; }
        }
    </style>
</head>
<body>

    <header class="header">
        <a href="index.html" class="logo">RJ <span>SPORTS</span></a>
        <div class="secure-tag"><i class="fas fa-shield-alt"></i> 100% SECURE</div>
    </header>

    <div class="checkout-wrapper">
        <div class="left-column">
            <div class="checkout-section">
                <div class="section-title"><i class="fas fa-user-circle"></i> 1. Contact Information</div>
                <div class="form-row">
                    <div class="form-group"><label>Full Name</label><input type="text" id="c-name" class="form-input" placeholder="Full name"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Phone Number</label><input type="tel" id="c-phone" class="form-input" placeholder="10-digit mobile" maxlength="10"></div>
                    <div class="form-group"><label>Email Address</label><input type="email" id="c-email" class="form-input" placeholder="Email"></div>
                </div>
                <label class="checkbox-group">
                    <input type="checkbox" id="c-whatsapp" checked>
                    Get updates on WhatsApp <i class="fab fa-whatsapp" style="color:#25D366;"></i>
                </label>
            </div>

            <div class="checkout-section">
                <div class="section-title"><i class="fas fa-map-marker-alt"></i> 2. Shipping Address</div>
                <div class="form-group"><label>Pincode</label><input type="text" id="s-pin" class="form-input" placeholder="6-digit Pincode" maxlength="6" onkeyup="autoDetectCity()"></div>
                <div class="form-row">
                    <div class="form-group"><label>City</label><input type="text" id="s-city" class="form-input" placeholder="City"></div>
                    <div class="form-group"><label>State</label>
                        <select id="s-state" class="form-input">
                            <option value="">Select State</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Address Line 1</label><input type="text" id="s-address" class="form-input" placeholder="Building, Street, Area"></div>
            </div>

            <div class="checkout-section">
                <div class="section-title"><i class="fas fa-truck"></i> 3. Delivery Method</div>
                <label class="option-box selected" onclick="selectDelivery('standard', 0, this)">
                    <div class="opt-left"><input type="radio" name="delivery" class="opt-radio" checked><div><div class="opt-title">Standard Delivery</div><div class="opt-desc">4-5 working days</div></div></div>
                    <div class="opt-price" style="color: var(--green);">FREE</div>
                </label>
                <label class="option-box" onclick="selectDelivery('express', 99, this)">
                    <div class="opt-left"><input type="radio" name="delivery" class="opt-radio"><div><div class="opt-title">Express Delivery âš¡</div><div class="opt-desc">1-2 days</div></div></div>
                    <div class="opt-price">+â‚¹99</div>
                </label>
            </div>

            <div class="checkout-section">
                <div class="section-title"><i class="fas fa-wallet"></i> 4. Payment Options</div>
                <label class="option-box selected" onclick="selectPayment('upi', this)"><div class="opt-left"><input type="radio" name="payment" value="UPI" class="opt-radio" checked><div><div class="opt-title">UPI (GPay/PhonePe)</div></div></div><i class="fas fa-qrcode"></i></label>
                <label class="option-box" onclick="selectPayment('cod', this)"><div class="opt-left"><input type="radio" name="payment" value="COD" class="opt-radio"><div><div class="opt-title">Cash on Delivery (COD)</div></div></div><i class="fas fa-money-bill-wave"></i></label>
                <div class="desktop-btn" style="margin-top: 25px;"><button class="btn-place-order" onclick="placeOrder()">PLACE ORDER NOW</button></div>
            </div>
        </div>

        <div class="right-column">
            <div class="summary-card">
                <div class="summary-items" id="checkout-items"></div>
                <div class="summary-totals">
                    <div class="calc-row"><span>Subtotal</span> <span id="t-sub">â‚¹0</span></div>
                    <div class="calc-row"><span style="color:var(--green)">Discount</span> <span id="t-disc" style="color:var(--green)">-â‚¹0</span></div>
                    <div class="calc-row"><span>Shipping</span> <span id="t-ship" style="color:var(--green)">FREE</span></div>
                    <div class="calc-total"><span>Total</span> <span id="t-final">â‚¹0</span></div>
                </div>
                <div class="savings-tag" id="t-savings">ðŸ”¥ You saved â‚¹0 today</div>
            </div>
        </div>
    </div>

    <div class="mobile-sticky-bar"><button class="btn-place-order" onclick="placeOrder()" id="mobile-btn-total">PLACE ORDER</button></div>
    <div id="toast">Message</div>

    <div class="modal-overlay" id="success-modal">
        <div class="modal-content">
            <div class="modal-icon"><i class="fas fa-check-circle"></i></div>
            <h2>Order Placed!</h2>
            <p>Invoice downloaded. Redirecting to WhatsApp...</p>
            <div class="loading-dots" style="color: var(--accent); font-weight: 800;">Please wait...</div>
        </div>
    </div>

    <script>
    let cartItems = [];
    let subtotal = 0, totalDiscount = 0, deliveryFee = 0, finalTotal = 0;
    let selectedPayMethod = "UPI";

    document.addEventListener('DOMContentLoaded', () => {
        cartItems = JSON.parse(localStorage.getItem('rj_cart')) || [];
        if (cartItems.length === 0) {
            showToast("Cart empty! Redirecting...");
            setTimeout(() => window.location.href = 'index.html', 2000);
            return;
        }
        renderSummary();
    });

    function renderSummary() {
        let html = ''; subtotal = 0; totalDiscount = 0;
        cartItems.forEach(item => {
            const price = parseFloat(item.price);
            const mrp = Math.round(price * 1.4);
            const qty = item.quantity || 1;
            subtotal += (mrp * qty);
            totalDiscount += ((mrp - price) * qty);
            html += `<div class="s-item"><img src="${item.image || ''}" class="s-img"><div class="s-info"><div class="s-name">${item.name}</div><div class="s-meta">Size: ${item.size} | Qty: ${qty}</div><div class="s-price">â‚¹${price.toLocaleString()}</div></div></div>`;
        });
        finalTotal = (subtotal - totalDiscount) + deliveryFee;
        document.getElementById('checkout-items').innerHTML = html;
        document.getElementById('t-sub').innerText = `â‚¹${subtotal.toLocaleString()}`;
        document.getElementById('t-disc').innerText = `-â‚¹${totalDiscount.toLocaleString()}`;
        document.getElementById('t-ship').innerText = deliveryFee === 0 ? "FREE" : `+â‚¹${deliveryFee}`;
        document.getElementById('t-final').innerText = `â‚¹${finalTotal.toLocaleString()}`;
        document.getElementById('t-savings').innerText = `ðŸ”¥ You saved â‚¹${totalDiscount.toLocaleString()} today`;
        document.getElementById('mobile-btn-total').innerText = `PLACE ORDER â€“ â‚¹${finalTotal.toLocaleString()}`;
    }

    function selectDelivery(type, fee, el) {
        document.querySelectorAll('input[name="delivery"]').forEach(r => {
            r.checked = false; r.closest('.option-box').classList.remove('selected');
        });
        el.querySelector('input').checked = true; el.classList.add('selected');
        deliveryFee = fee; renderSummary();
    }

    function selectPayment(method, el) {
        document.querySelectorAll('input[name="payment"]').forEach(r => {
            r.checked = false; r.closest('.option-box').classList.remove('selected');
        });
        const input = el.querySelector('input'); input.checked = true;
        el.classList.add('selected'); selectedPayMethod = input.value;
    }

    function autoDetectCity() {
        const pin = document.getElementById('s-pin').value;
        if (pin.length === 6) {
            if(pin.startsWith('41')) { 
                document.getElementById('s-city').value = 'Pune'; 
                document.getElementById('s-state').value = 'Maharashtra'; 
            }
            showToast("Location detected!");
        }
    }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.innerText = msg; toast.className = "show";
        setTimeout(() => { toast.className = ""; }, 3000);
    }

    // --- Invoice Generation Function ---
    function generateInvoice(orderData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(22);
        doc.setTextColor(225, 6, 0); 
        doc.text("RJ SPORTS", 20, 20);
        
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text("Premium Sports Gear & Footwear", 20, 27);
        doc.text(`Order ID: #${orderData.orderId}`, 140, 20);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 140, 27);

        doc.setDrawColor(200);
        doc.line(20, 35, 190, 35);
        doc.setFontSize(12);
        doc.setTextColor(0);
        doc.text("BILL TO:", 20, 45);
        doc.setFontSize(10);
        doc.text(`${orderData.customer}`, 20, 52);
        doc.text(`${orderData.phone}`, 20, 57);
        doc.text(`${orderData.address}`, 20, 62);

        const tableRows = orderData.items.map(item => [
            item.name, item.size, item.quantity, `INR ${item.price}`
        ]);

        doc.autoTable({
            startY: 70,
            head: [['Product Name', 'Size', 'Qty', 'Price']],
            body: tableRows,
            theme: 'grid',
            headStyles: { fillColor: [18, 18, 18] }
        });

        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(12);
        doc.text(`Payment Mode: ${orderData.paymentMethod}`, 20, finalY);
        doc.setFontSize(14);
        doc.text(`GRAND TOTAL: INR ${orderData.total.toLocaleString()}`, 120, finalY);
        doc.text("Thank you for shopping!", 20, finalY + 20);

        doc.save(`Invoice-${orderData.orderId}.pdf`);
    }

    async function placeOrder() {
        const name = document.getElementById('c-name').value.trim();
        const phone = document.getElementById('c-phone').value.trim();
        const address = document.getElementById('s-address').value.trim();
        const city = document.getElementById('s-city').value.trim();
        const state = document.getElementById('s-state').value;
        const pin = document.getElementById('s-pin').value.trim();

        if (!name || phone.length !== 10 || !address || !city || !state || !pin) {
            return showToast("Fill all details correctly!");
        }

        const orderId = 'RJ' + Math.floor(Math.random() * 1000000);
        const orderData = { orderId, customer: name, phone, address: `${address}, ${city}, ${state}`, pincode: pin, items: cartItems, total: finalTotal, paymentMethod: selectedPayMethod };

        let itemsStr = "";
        cartItems.forEach(item => { itemsStr += `â–ªï¸ ${item.quantity}x ${item.name} (Size: ${item.size})\n`; });

        const msg = `ðŸ *RJ SPORTS - NEW ORDER!* ðŸ\n` +
                    `-----------------------------------\n` +
                    `*ðŸ†” Order ID:* #${orderId}\n` +
                    `*ðŸ‘¤ Customer:* ${name}\n` +
                    `*ðŸ“ž Phone:* ${phone}\n\n` +
                    `*ðŸ›’ Items:*\n${itemsStr}` +
                    `*ðŸ’° Total:* â‚¹${finalTotal.toLocaleString()}\n` +
                    `*ðŸ’³ Payment:* ${selectedPayMethod}\n` +
                    `-----------------------------------\n`;

        const myWhatsAppNumber = "919359239161";
        const whatsappUrl = `https://wa.me/${myWhatsAppNumber}?text=${encodeURIComponent(msg)}`;

        try {
            await fetch('/api/place-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            localStorage.removeItem('rj_cart');
            generateInvoice(orderData); // à¤¬à¤¿à¤² à¤¡à¤¾à¤Šà¤¨à¤²à¥‹à¤¡ à¤•à¤°à¤¾
            document.getElementById('success-modal').style.display = 'flex';
            setTimeout(() => { window.location.href = whatsappUrl; }, 3000);

        } catch (e) {
            localStorage.removeItem('rj_cart');
            generateInvoice(orderData);
            window.location.href = whatsappUrl;
        }
    }
    </script>
</body>
</html>