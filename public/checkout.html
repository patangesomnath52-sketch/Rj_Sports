<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout | RJ Sports</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ... ‡§§‡•Å‡§Æ‡§ö‡•á ‡§Ü‡§ß‡•Ä‡§ö‡•á ‡§∏‡§∞‡•ç‡§µ CSS ‡§§‡§∏‡•á‡§ö ‡§†‡•á‡§µ‡§æ ... */
        :root {
            --bg-color: #f5f5f5;
            --text-color: #121212;
            --accent: #E10600; 
            --green: #03a685;
            --border-color: #e5e7eb;
        }
        /* (‡§Ø‡•á‡§•‡•á ‡§§‡•Å‡§Æ‡§ö‡•á ‡§∏‡§∞‡•ç‡§µ ‡§ú‡•Å‡§®‡•á CSS ‡§ï‡•ã‡§°‡•ç‡§∏ ‡•≤‡§° ‡§ï‡§∞‡§æ ‡§ú‡•á ‡§Æ‡•Ä ‡§Ü‡§ß‡•Ä ‡§¶‡§ø‡§≤‡•á ‡§π‡•ã‡§§‡•á) */
    </style>
</head>
<body>

<script>
    let cartItems = [];
    let subtotal = 0, totalDiscount = 0, deliveryFee = 0, finalTotal = 0;
    let selectedPayMethod = "Cash on Delivery"; 

    document.addEventListener('DOMContentLoaded', () => {
        cartItems = JSON.parse(localStorage.getItem('rj_cart')) || [];
        if (cartItems.length === 0) {
            showToast("Cart empty! Redirecting...");
            setTimeout(() => window.location.href = 'index.html', 2000);
            return;
        }
        renderSummary();

        if(window.innerWidth > 768) { 
            const summaryContent = document.getElementById('summary-content');
            if(summaryContent) summaryContent.classList.add('open'); 
        }
    });

    function renderSummary() {
        let html = ''; 
        subtotal = 0; 
        totalDiscount = 0;

        cartItems.forEach(item => {
            const price = parseFloat(item.price) || 0;
            const mrp = Math.round(price * 1.4); 
            const qty = item.quantity || 1;
            
            subtotal += (mrp * qty);
            totalDiscount += ((mrp - price) * qty);

            html += `
            <div class="s-item">
                <img src="${item.image || ''}" class="s-img">
                <div class="s-info">
                    <div class="s-name">${item.name}</div>
                    <div class="s-meta">Size: ${item.size} | Qty: ${qty}</div>
                    <div class="s-price">‚Çπ${price.toLocaleString()} <span style="text-decoration:line-through; color:#878787; font-size:12px; font-weight:normal;">‚Çπ${mrp.toLocaleString()}</span></div>
                </div>
            </div>`;
        });

        finalTotal = (subtotal - totalDiscount) + deliveryFee;

        document.getElementById('checkout-items').innerHTML = html;
        document.getElementById('t-sub').innerText = `‚Çπ${subtotal.toLocaleString()}`;
        document.getElementById('t-disc').innerText = `-‚Çπ${totalDiscount.toLocaleString()}`;
        document.getElementById('t-ship').innerText = deliveryFee === 0 ? "FREE" : `+‚Çπ${deliveryFee}`;
        document.getElementById('t-final').innerText = `‚Çπ${finalTotal.toLocaleString()}`;
        document.getElementById('t-savings').innerText = `üî• You saved ‚Çπ${totalDiscount.toLocaleString()} today`;
        
        const mobileTotal = document.getElementById('mobile-summary-total');
        const mobileBtn = document.getElementById('mobile-btn-total');
        if(mobileTotal) mobileTotal.innerText = `‚Çπ${finalTotal.toLocaleString()}`;
        if(mobileBtn) mobileBtn.innerText = `PLACE ORDER ‚Äì ‚Çπ${finalTotal.toLocaleString()}`;
    }

    function selectDelivery(type, fee, el) {
        document.querySelectorAll('input[name="delivery"]').forEach(r => {
            r.checked = false; 
            const box = r.closest('.option-box');
            if(box) box.classList.remove('selected');
        });
        const radio = el.querySelector('input');
        if(radio) radio.checked = true; 
        el.classList.add('selected');
        deliveryFee = fee; 
        renderSummary(); 
    }

    function autoDetectCity() {
        const pin = document.getElementById('s-pin').value;
        if (pin.length === 6) {
            // Mock logic: 411 = Pune, 400 = Mumbai, 110 = Delhi
            if(pin.startsWith('41')) { 
                document.getElementById('s-city').value = 'Pune'; 
                document.getElementById('s-state').value = 'Maharashtra'; 
            } else if(pin.startsWith('40')) {
                document.getElementById('s-city').value = 'Mumbai'; 
                document.getElementById('s-state').value = 'Maharashtra';
            }
            showToast("Location detected!");
        }
    }

    function toggleSummary() { 
        document.getElementById('summary-content').classList.toggle('open'); 
    }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        if(!toast) return;
        toast.innerText = msg; toast.className = "show";
        setTimeout(() => { toast.className = ""; }, 3000);
    }

    function generateInvoice(orderData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(18, 18, 18);
        doc.rect(0, 0, 210, 50, 'F');

        doc.setFontSize(32);
        doc.setTextColor(255, 255, 255);
        doc.text("RJ", 20, 30);
        doc.setTextColor(225, 6, 0); 
        doc.text("SPORTS", 36, 30);

        doc.setFontSize(10);
        doc.setTextColor(180, 180, 180);
        doc.text("PREMIUM GEAR | OFFICIAL INVOICE", 20, 38);

        doc.setTextColor(18, 18, 18);
        doc.setFontSize(12);
        doc.text(`Customer: ${orderData.customer}`, 20, 65);
        doc.text(`Order ID: #${orderData.orderId}`, 20, 72);

        const tableRows = orderData.items.map(item => [
            item.name.toUpperCase(),
            `UK ${item.size}`,
            item.quantity,
            `INR ${parseFloat(item.price).toLocaleString()}`
        ]);

        doc.autoTable({
            startY: 85,
            head: [['ITEM', 'SIZE', 'QTY', 'PRICE']],
            body: tableRows,
            theme: 'grid',
            headStyles: { fillColor: [18, 18, 18], textColor: [255, 255, 255] }
        });

        const finalY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14);
        doc.text(`GRAND TOTAL: INR ${orderData.total.toLocaleString()}`, 120, finalY);

        doc.save(`Invoice_${orderData.orderId}.pdf`);
    }

    async function placeOrder() {
        const name = document.getElementById('c-name').value.trim();
        const phone = document.getElementById('c-phone').value.trim();
        const address = document.getElementById('s-address').value.trim();
        const city = document.getElementById('s-city').value.trim();
        const state = document.getElementById('s-state').value;
        const pin = document.getElementById('s-pin').value.trim();

        if (!name || phone.length !== 10 || !address || !city || !state || !pin) {
            return showToast("Please fill all details correctly!");
        }

        const orderId = 'RJ' + Math.floor(Math.random() * 1000000);
        const orderData = { orderId, customer: name, phone, address: `${address}, ${city}, ${state} - ${pin}`, items: cartItems, total: finalTotal, paymentMethod: "Cash on Delivery" };

        let itemsStr = "";
        cartItems.forEach(item => { itemsStr += `‚ñ™Ô∏è ${item.quantity}x ${item.name} (Size: ${item.size})\n`; });

        const msg = `üèè *RJ SPORTS - NEW ORDER!* üèè\n` +
                    `-----------------------------------\n` +
                    `*üÜî Order ID:* #${orderId}\n` +
                    `*üë§ Customer:* ${name}\n` +
                    `*üìû Phone:* ${phone}\n` +
                    `*üìç Address:* ${address}, ${city}, ${state} - ${pin}\n` +
                    `-----------------------------------\n` +
                    `*üõí Items:*\n${itemsStr}` +
                    `*üí∞ Total:* ‚Çπ${finalTotal.toLocaleString()}\n` +
                    `*üí≥ Payment:* Cash on Delivery\n` +
                    `-----------------------------------\n` +
                    `_Please process my order!_`;

        const myWhatsAppNumber = "919359239161";
        const whatsappUrl = `https://wa.me/${myWhatsAppNumber}?text=${encodeURIComponent(msg)}`;

        try {
            await fetch('/api/place-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            generateInvoice(orderData);
            localStorage.removeItem('rj_cart');
            document.getElementById('success-modal').style.display = 'flex';
            setTimeout(() => { window.location.href = whatsappUrl; }, 3000);

        } catch (e) {
            generateInvoice(orderData);
            window.location.href = whatsappUrl;
        }
    }
</script>

</body>
</html>